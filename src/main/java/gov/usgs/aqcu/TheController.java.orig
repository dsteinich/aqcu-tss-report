package gov.usgs.aqcu;

<<<<<<< HEAD
import java.io.IOException;
=======
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;

import java.time.Instant;
>>>>>>> refs/remotes/zack/report-model

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.core.io.Resource;
import org.springframework.util.FileCopyUtils;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

<<<<<<< HEAD
import gov.usgs.aqcu.client.JavaToRClient;
=======
import com.aquaticinformatics.aquarius.sdk.timeseries.servicemodels.Publish.TimeSeriesDescriptionListByUniqueIdServiceResponse;
import com.aquaticinformatics.aquarius.sdk.timeseries.servicemodels.Publish.ProcessorListServiceResponse;
import com.aquaticinformatics.aquarius.sdk.timeseries.servicemodels.Publish.RatingCurveListServiceResponse;

import gov.usgs.aqcu.model.TimeSeriesSummaryReport;

>>>>>>> refs/remotes/zack/report-model
import gov.usgs.aqcu.retrieval.TimeSeriesMetadataService;
import gov.usgs.aqcu.retrieval.RatingCurveListService;
import gov.usgs.aqcu.retrieval.UpchainProcessorListService;

import gov.usgs.aqcu.builder.TimeSeriesSummaryReportBuilderService;

@RestController
@RequestMapping("/timeseriessummary")
public class TheController {
	private static final Logger LOG = LoggerFactory.getLogger(TheController.class);
	private Gson gson;
	private TimeSeriesMetadataService timeSeriesMetadataService;
<<<<<<< HEAD
	private JavaToRClient javaToRClient;

	@Value("classpath:testData/timeSeriesSummary.json")
	private Resource mpPub1;
	@Bean
	public String reportJson() throws IOException {
		return new String(FileCopyUtils.copyToByteArray(mpPub1.getInputStream()));
	}
=======
	private RatingCurveListService ratingCurveListService;
	private UpchainProcessorListService upchainProcessorListService;
	private TimeSeriesSummaryReportBuilderService reportBuilderService;
>>>>>>> refs/remotes/zack/report-model

	@Autowired
<<<<<<< HEAD
	public TheController(TimeSeriesMetadataService timeSeriesMetadataService, JavaToRClient javaToRClient) {
=======
	public TheController(
		TimeSeriesMetadataService timeSeriesMetadataService, 
		UpchainProcessorListService upchainProcessorListService, 
		RatingCurveListService ratingCurveListService,
		TimeSeriesSummaryReportBuilderService reportBuilderService) {
>>>>>>> refs/remotes/zack/report-model
		this.timeSeriesMetadataService = timeSeriesMetadataService;
<<<<<<< HEAD
		this.javaToRClient = javaToRClient;
=======
		this.upchainProcessorListService = upchainProcessorListService;
		this.ratingCurveListService = ratingCurveListService;
		this.reportBuilderService = reportBuilderService;
>>>>>>> refs/remotes/zack/report-model
	}

	@GetMapping
<<<<<<< HEAD
	public byte[] getReport(
=======
	public TimeSeriesSummaryReport getReport(
>>>>>>> refs/remotes/zack/report-model
			@RequestParam String primaryTimeseriesIdentifier,
			@RequestParam String station,
			@RequestParam(required=false) String lastMonths,
			@RequestParam(required=false) String waterYear,
<<<<<<< HEAD
			@RequestParam(required=false) String startDate,
			@RequestParam(required=false) String endDate,
			@RequestParam(required=false) String excludedCorrections) throws IOException {

//		timeSeriesMetadataService.get(primaryTimeseriesIdentifier);

		return javaToRClient.render("drsteini", "timeseriessummary", reportJson());
=======
			@RequestParam(required=false) String startDateString,
			@RequestParam(required=false) String endDateString,
			@RequestParam(required=false) String excludedCorrections) {	
	
		Instant startDate = Instant.parse(startDateString);
		Instant endDate = Instant.parse(endDateString);
		
		//Fetch Time Series Descriptions
		TimeSeriesDescriptionListByUniqueIdServiceResponse metadataResponse = timeSeriesMetadataService.get(primaryTimeseriesIdentifier);
		
		//Fetch Upchain Processors
		ProcessorListServiceResponse processorsResponse = upchainProcessorListService.get(primaryTimeseriesIdentifier, startDate, endDate);
		
		//Fetch Rating Curves IFF we got at least one upchain processor to pull the rating model identifier from
		RatingCurveListServiceResponse ratingCurvesResponse = null;
		if(processorsResponse != null && processorsResponse.getProcessors() != null && processorsResponse.getProcessors().size() > 0) {
			ratingCurvesResponse = ratingCurveListService.get(processorsResponse.getProcessors().get(0).getInputRatingModelIdentifier(), null, startDate, endDate);
		}
		
		//Build the TSS Report JSON
		TimeSeriesSummaryReport report = reportBuilderService.buildTimeSeriesSummaryReport(metadataResponse, ratingCurvesResponse);
		
		return report;
>>>>>>> refs/remotes/zack/report-model
	}
	
}
